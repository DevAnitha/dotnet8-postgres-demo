create table if not exists one_stop_office_separation (
  one_stop_office_separation_id int generated by default as identity primary key,
  separation_initiation_id int not null,   
  one_stop_office_id int not null,
  validation_notes text,                   
  approved_by int,
  approved_date timestamp,
  record_status_id int,

  created_by int,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_one_stop_office_separation_office
    foreign key (one_stop_office_id) references one_stop_offices(one_stop_office_id)
constraint fk_one_stop_office_separation_initiation
 foreign key (separation_initiation_id) references separation_initiation(separation_initiation_id));
 ----------------------------
 create table if not exists one_stop_office_separation_checklist (
  one_stop_office_separation_checklist_id int generated by default as identity primary key,
  one_stop_office_separation_id int not null,
  one_stop_office_item_id int not null,
  one_stop_checklist_status_id int not null,
  checklist_answer_text text,
  completed_by int,
  completed_date timestamp,
  validated_by int,
  validated_date timestamp,
  record_status_id int,

  created_by int,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_one_stop_sep_checklist_sep
    foreign key (one_stop_office_separation_id)
      references one_stop_office_separation(one_stop_office_separation_id),

  constraint fk_one_stop_sep_checklist_item
    foreign key (one_stop_office_item_id)
      references one_stop_office_items(one_stop_office_item_id),

  constraint fk_one_stop_sep_checklist_status
    foreign key (one_stop_checklist_status_id)
      references one_stop_checklist_statuses(one_stop_checklist_status_id)
);




---------------------------------------------
---------------------------------------------
create table if not exists one_stop_request_change_issue_types (
  one_stop_request_change_issue_type_id int generated by default as identity primary key,
  issue_type_name text not null,
  one_stop_office_id int not null,
  sort_order int,
  record_status_id int,

  created_by uuid,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by uuid,
  modified_date timestamp,
  modified_machine text,
  deleted_by uuid,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_one_stop_rc_issue_types_office
    foreign key (one_stop_office_id) references one_stop_offices(one_stop_office_id)
);

create unique index if not exists ux_one_stop_rc_issue_types_office_name
  on one_stop_request_change_issue_types(one_stop_office_id, issue_type_name);


-- 3B) one_stop_office_request_changes (parent submission)
create table if not exists one_stop_office_request_changes (
  one_stop_office_request_change_id int generated by default as identity primary key,
  one_stop_office_separation_id int not null,
  additional_notes text not null,
  requested_by int not null,
  requested_date timestamp not null default now(),
  record_status_id int,

  created_by uuid,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by uuid,
  modified_date timestamp,
  modified_machine text,
  deleted_by uuid,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_one_stop_office_request_changes_sep
    foreign key (one_stop_office_separation_id)
      references one_stop_office_separation(one_stop_office_separation_id)
);


-- 3C) one_stop_office_request_change_checklist (bridge)
create table if not exists one_stop_office_request_change_checklist (
  one_stop_office_request_change_checklist_id int generated by default as identity primary key,
  one_stop_office_request_change_id int not null,
  one_stop_request_change_issue_type_id int not null,

 
  request_change_issue_type_status boolean null,

  record_status_id int,

  created_by uuid,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by uuid,
  modified_date timestamp,
  modified_machine text,
  deleted_by uuid,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_one_stop_rc_checklist_request
    foreign key (one_stop_office_request_change_id)
      references one_stop_office_request_changes(one_stop_office_request_change_id),

  constraint fk_one_stop_rc_checklist_issue_type
    foreign key (one_stop_request_change_issue_type_id)
      references one_stop_request_change_issue_types(one_stop_request_change_issue_type_id)
);

create unique index if not exists ux_one_stop_rc_checklist_request_issue
  on one_stop_office_request_change_checklist(one_stop_office_request_change_id, one_stop_request_change_issue_type_id);


/* ============================================================
   4) NOTIFICATION TEMPLATE 
   ============================================================ */

create table if not exists one_stop_notification_template (
  one_stop_notification_template_id int generated by default as identity primary key,

  -- Recommendation: treat this as a stable code; keep it unique
  template_type text not null,          -- (optional rename later: template_code)

  subject_template text not null,
  body_template text not null,
  record_status_id int,

  created_by uuid,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by uuid,
  modified_date timestamp,
  modified_machine text,
  deleted_by uuid,
  deleted_date timestamp,
  deleted_machine text
);

create unique index if not exists ux_one_stop_notification_template_type
  on one_stop_notification_template(template_type);


/* ============================================================
   5) validation_notes was originally on one_stop_office_separation_checklist.
   
   ============================================================ */

alter table one_stop_office_separation_checklist
  drop column if exists validation_notes;

---------------------------------------------------------------------------

  -- =====================================================
-- Step 1: Drop columns you no longer want
-- =====================================================

ALTER TABLE public.one_stop_office_separation_checklist
  DROP COLUMN IF EXISTS validation_notes,
  DROP COLUMN IF EXISTS one_stop_office_id;


-- =====================================================
-- Step 2: Add one_stop_office_separation_id
-- =====================================================

ALTER TABLE public.one_stop_office_separation_checklist
  ADD COLUMN one_stop_office_separation_id integer;


-- =====================================================
-- Step 3: Backfill data (IMPORTANT)
-- Only run this if the table already has data
-- Adjust join if needed
-- =====================================================

UPDATE public.one_stop_office_separation_checklist osc
SET one_stop_office_separation_id = os.one_stop_office_separation_id
FROM public.one_stop_office_separation os
WHERE os.separation_initiation_id = osc.separation_initiation_id
  AND os.one_stop_office_id = (
      SELECT oi.one_stop_office_id
      FROM public.one_stop_office_items oi
      WHERE oi.one_stop_office_item_id = osc.one_stop_office_item_id
  );


-- =====================================================
-- Step 4: Enforce NOT NULL once data is backfilled
-- =====================================================

ALTER TABLE public.one_stop_office_separation_checklist
  ALTER COLUMN one_stop_office_separation_id SET NOT NULL;


-- =====================================================
-- Step 5: Add FK constraint
-- =====================================================

ALTER TABLE public.one_stop_office_separation_checklist
  ADD CONSTRAINT fk_os_sep_checklist_sep
  FOREIGN KEY (one_stop_office_separation_id)
  REFERENCES public.one_stop_office_separation (one_stop_office_separation_id)
  ON UPDATE NO ACTION
  ON DELETE NO ACTION;


-- =====================================================
-- Step 6: (Recommended) Prevent duplicate checklist rows
-- =====================================================

CREATE UNIQUE INDEX IF NOT EXISTS ux_os_sep_checklist_sep_item
  ON public.one_stop_office_separation_checklist
     (one_stop_office_separation_id, one_stop_office_item_id);


------------------------------
CREATE TABLE IF NOT EXISTS public.one_stop_office_separation (
  one_stop_office_separation_id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  separation_initiation_id int NOT NULL,
  one_stop_office_id int NOT NULL,
  validation_notes text,
  approved_by int,
  approved_date timestamp,
  record_status_id int,

  created_by int,
  created_date timestamp NOT NULL DEFAULT now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text,

  CONSTRAINT fk_one_stop_office_separation_office
    FOREIGN KEY (one_stop_office_id)
    REFERENCES public.one_stop_offices (one_stop_office_id)
    ON UPDATE NO ACTION
    ON DELETE NO ACTION,

  CONSTRAINT fk_one_stop_office_separation_initiation
    FOREIGN KEY (separation_initiation_id)
    REFERENCES public.separation_initiation (separation_initiation_id)
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
);


------------------------------------------------------
------------------------------------------------------
------------------------------------------------------

create table if not exists public.one_stop_request_change_issue_types
(
  one_stop_request_change_issue_type_id int generated by default as identity primary key,
  issue_type_name text not null,
  one_stop_office_id int not null,
  sort_order int,
  record_status_id int,

  created_by int,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_os_rc_issue_types_office
    foreign key (one_stop_office_id)
    references public.one_stop_offices(one_stop_office_id)
    on update no action
    on delete no action
);

-----------------------------------------------------------------
create table if not exists public.one_stop_office_request_changes
(
  one_stop_office_request_change_id int generated by default as identity primary key,
  one_stop_office_separation_id int not null,
  additional_notes text not null,
  requested_by int not null,
  requested_date timestamp not null default now(),
  record_status_id int,

  created_by int,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_os_office_request_changes_sep
    foreign key (one_stop_office_separation_id)
    references public.one_stop_office_separation(one_stop_office_separation_id)
    on update no action
    on delete no action
);

create index if not exists ix_os_office_request_changes_sep
  on public.one_stop_office_request_changes(one_stop_office_separation_id);

-----------------------------------------------------------------------
create table if not exists public.one_stop_office_request_change_checklist
(
  one_stop_office_request_change_checklist_id int generated by default as identity primary key,
  one_stop_office_request_change_id int not null,
  one_stop_request_change_issue_type_id int not null,
  request_change_issue_type_status boolean null, -- NULL=pending/unset, TRUE=selected, FALSE=unselected (if you store both)
  record_status_id int,

  created_by int,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_os_rc_checklist_request
    foreign key (one_stop_office_request_change_id)
    references public.one_stop_office_request_changes(one_stop_office_request_change_id)
    on update no action
    on delete no action,

  constraint fk_os_rc_checklist_issue_type
    foreign key (one_stop_request_change_issue_type_id)
    references public.one_stop_request_change_issue_types(one_stop_request_change_issue_type_id)
    on update no action
    on delete no action
);

create index if not exists ix_os_rc_checklist_request
  on public.one_stop_office_request_change_checklist(one_stop_office_request_change_id);

--------------------------------------------------
create table if not exists public.one_stop_notification_template
(
  one_stop_notification_template_id int generated by default as identity primary key,
  template_type text not null,     -- recommend treat as stable code, make unique
  subject_template text not null,
  body_template text not null,
  record_status_id int,

  created_by int,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text
);

create unique index if not exists ux_os_notification_template_type
  on public.one_stop_notification_template(template_type);



-- ============================================================
-- 5) Email log: one_stop_notification_log
-- ============================================================
create table if not exists public.one_stop_notification_log
(
  one_stop_notification_log_id int generated by default as identity primary key,
  one_stop_notification_template_id int not null,
  separation_initiation_id int not null,

  sender text,
  recipient text not null,
  mail_cc text,
  subject text,
  body text,

  is_send_success boolean null, -- NULL=not attempted, TRUE=sent, FALSE=failed
  provider_message text,        -- recommend rename to provider_message_id if desired

  attempt_count int not null default 0,
  max_attempt_count int not null default 3,
  last_fail_attempt_message text,
  last_fail_attempt_date timestamp,
  sent_date timestamp,

  record_status_id int,

  created_by int,
  created_date timestamp not null default now(),
  created_machine text,
  modified_by int,
  modified_date timestamp,
  modified_machine text,
  deleted_by int,
  deleted_date timestamp,
  deleted_machine text,

  constraint fk_os_notification_log_template
    foreign key (one_stop_notification_template_id)
    references public.one_stop_notification_template(one_stop_notification_template_id)
    on update no action
    on delete no action,

  constraint fk_os_notification_log_sep_initiation
    foreign key (separation_initiation_id)
    references public.separation_initiation(separation_initiation_id)
    on update no action
    on delete no action
);

create index if not exists ix_os_notification_log_template
  on public.one_stop_notification_log(one_stop_notification_template_id);

create index if not exists ix_os_notification_log_sep_initiation
  on public.one_stop_notification_log(separation_initiation_id);

create index if not exists ix_os_notification_log_sent_date
  on public.one_stop_notification_log(sent_date);

  -----------------------------
  ------------------------=====
  -----------------------------

  /* ============================================================
   Remove separation_initiation_id from one_stop_office_separation_checklist
   + drop the FK constraint that uses it
   (safe even if names differ)
   ============================================================ */

-- 1) Drop the FK constraint (if you know the exact name, keep this line)
ALTER TABLE public.one_stop_office_separation_checklist
  DROP CONSTRAINT IF EXISTS fk_os_checklist_separation_initiation;

-- 2) If pgAdmin generated a different constraint name, run this query to find it:
--    (optional helper)
-- SELECT conname
-- FROM pg_constraint
-- WHERE conrelid = 'public.one_stop_office_separation_checklist'::regclass
--   AND contype = 'f';

-- 3) Drop the column
ALTER TABLE public.one_stop_office_separation_checklist
  DROP COLUMN IF EXISTS separation_initiation_id;


-------------
SELECT conname
FROM pg_constraint
WHERE conrelid = 'public.one_stop_office_separation_checklist'::regclass
  AND contype = 'f';

----------------
ALTER TABLE public.one_stop_office_separation_checklist
  DROP CONSTRAINT IF EXISTS <paste_constraint_name_here>;
