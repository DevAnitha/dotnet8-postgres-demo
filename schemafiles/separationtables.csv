-- =========================
-- LOOKUP TABLES
-- =========================

CREATE TABLE IF NOT EXISTS separation_type (
  separation_type_id      int GENERATED BY DEFAULT AS IDENTITY,
  separation_type_name    text NOT NULL,
  sort_order              int NULL,
  record_status_id        int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_separation_type PRIMARY KEY (separation_type_id),
  CONSTRAINT uq_separation_type_name UNIQUE (separation_type_name)
);

CREATE TABLE IF NOT EXISTS separation_status (
  separation_status_id    int GENERATED BY DEFAULT AS IDENTITY,
  separation_status_name  text NOT NULL,
  sort_order              int NULL,
  record_status_id        int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_separation_status PRIMARY KEY (separation_status_id),
  CONSTRAINT uq_separation_status_name UNIQUE (separation_status_name)
);

CREATE TABLE IF NOT EXISTS separation_offices (
  separation_office_id    int GENERATED BY DEFAULT AS IDENTITY,
  separation_office_name  text NOT NULL,
  sort_order              int NULL,
  record_status_id        int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_separation_offices PRIMARY KEY (separation_office_id),
  CONSTRAINT uq_separation_offices_name UNIQUE (separation_office_name)
);


-- =========================
-- TRANSACTION TABLE
-- =========================

CREATE TABLE IF NOT EXISTS separation_initiation (
  separation_initiation_id  int GENERATED BY DEFAULT AS IDENTITY,
  core_identity_id          uuid NOT NULL,
  last_day                  timestamp NULL,
  separation_date           timestamp NULL,
  separation_type_id        int NOT NULL,
  reason_for_separation     text NULL,
  notify_employee           boolean NULL,
  instant_separation        boolean NULL,
  additional_notes          text NULL,
  separation_status_id      int NOT NULL,
  record_status_id          int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_separation_initiation PRIMARY KEY (separation_initiation_id)
);


-- =========================
-- OFFICE CHECKLIST (junction)
-- =========================

CREATE TABLE IF NOT EXISTS separation_offices_core_checklist (
  separation_offices_core_checklist_id  int GENERATED BY DEFAULT AS IDENTITY,
  separation_initiation_id              int NOT NULL,
  separation_office_id                  int NOT NULL,
  record_status_id                      int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_sep_offices_core_checklist PRIMARY KEY (separation_offices_core_checklist_id),
  CONSTRAINT uq_sep_initiation_office UNIQUE (separation_initiation_id, separation_office_id)
);


-- =========================
-- OFFICE ITEM DEFINITIONS
-- =========================

CREATE TABLE IF NOT EXISTS separation_office_items (
  separation_office_item_id    int GENERATED BY DEFAULT AS IDENTITY,
  separation_office_id         int NOT NULL,
  separation_office_item_name  text NOT NULL,
  sort_order                   int NULL,
  record_status_id             int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_separation_office_items PRIMARY KEY (separation_office_item_id),
  CONSTRAINT uq_sep_office_item_name UNIQUE (separation_office_id, separation_office_item_name)
);


-- =========================
-- ITEM COMPLETION (per separation office checklist)
-- =========================

CREATE TABLE IF NOT EXISTS separation_office_item_core_checklist (
  separation_office_item_core_checklist_id  int GENERATED BY DEFAULT AS IDENTITY,
  separation_offices_core_checklist_id      int NOT NULL,
  separation_office_item_id                 int NOT NULL,
  is_complete                               boolean NOT NULL DEFAULT false,
  completed_date                            timestamp NULL,
  completed_by                              uuid NULL,
  record_status_id                          int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_sep_office_item_core_checklist PRIMARY KEY (separation_office_item_core_checklist_id),
  CONSTRAINT uq_sep_checklist_item UNIQUE (separation_offices_core_checklist_id, separation_office_item_id),

  CONSTRAINT ck_sep_item_complete_requires_who_when
    CHECK (
      (is_complete = false)
      OR (completed_date IS NOT NULL AND completed_by IS NOT NULL)
    )
);


-- =========================
-- SUPERVISOR ASSIGNMENT
-- =========================

CREATE TABLE IF NOT EXISTS separation_supervisor (
  separation_supervisor_id  int GENERATED BY DEFAULT AS IDENTITY,
  separation_initiation_id  int NOT NULL,
  supervisor_id             uuid NOT NULL,
  job_id                    uuid NULL,
  flag                      text NULL,
  record_status_id          int NULL,

  -- auditfields
  created_by        uuid NULL,
  created_date      timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_machine   text NULL DEFAULT inet_client_addr()::text,
  modified_by       uuid NULL,
  modified_date     timestamp NULL,
  modified_machine  text NULL,
  deleted_by        uuid NULL,
  deleted_date      timestamp NULL,
  deleted_machine   text NULL,

  CONSTRAINT pk_separation_supervisor PRIMARY KEY (separation_supervisor_id),

  -- Multiple supervisors allowed but no duplicates:
  CONSTRAINT uq_sep_supervisor_no_duplicates UNIQUE (separation_initiation_id, supervisor_id)
);


-- =========================
-- FOREIGN KEYS (run after referenced tables exist)
-- Assumes these exist:
--   core_identity(core_identity_id uuid)
--   record_status(record_status_id int)
--   job(job_id uuid)
-- =========================

ALTER TABLE separation_initiation
  ADD CONSTRAINT fk_sep_initiation_core_identity
    FOREIGN KEY (core_identity_id) REFERENCES core_identity(core_identity_id);

ALTER TABLE separation_initiation
  ADD CONSTRAINT fk_sep_initiation_type
    FOREIGN KEY (separation_type_id) REFERENCES separation_type(separation_type_id);

ALTER TABLE separation_initiation
  ADD CONSTRAINT fk_sep_initiation_status
    FOREIGN KEY (separation_status_id) REFERENCES separation_status(separation_status_id);

ALTER TABLE separation_initiation
  ADD CONSTRAINT fk_sep_initiation_record_status
    FOREIGN KEY (record_status_id) REFERENCES record_status(record_status_id);


ALTER TABLE separation_offices_core_checklist
  ADD CONSTRAINT fk_sep_office_checklist_initiation
    FOREIGN KEY (separation_initiation_id) REFERENCES separation_initiation(separation_initiation_id);

ALTER TABLE separation_offices_core_checklist
  ADD CONSTRAINT fk_sep_office_checklist_office
    FOREIGN KEY (separation_office_id) REFERENCES separation_offices(separation_office_id);

ALTER TABLE separation_offices_core_checklist
  ADD CONSTRAINT fk_sep_office_checklist_record_status
    FOREIGN KEY (record_status_id) REFERENCES record_status(record_status_id);


ALTER TABLE separation_office_items
  ADD CONSTRAINT fk_sep_office_items_office
    FOREIGN KEY (separation_office_id) REFERENCES separation_offices(separation_office_id);

ALTER TABLE separation_office_items
  ADD CONSTRAINT fk_sep_office_items_record_status
    FOREIGN KEY (record_status_id) REFERENCES record_status(record_status_id);


ALTER TABLE separation_office_item_core_checklist
  ADD CONSTRAINT fk_sep_item_checklist_parent
    FOREIGN KEY (separation_offices_core_checklist_id)
    REFERENCES separation_offices_core_checklist(separation_offices_core_checklist_id);

ALTER TABLE separation_office_item_core_checklist
  ADD CONSTRAINT fk_sep_item_checklist_item
    FOREIGN KEY (separation_office_item_id)
    REFERENCES separation_office_items(separation_office_item_id);

ALTER TABLE separation_office_item_core_checklist
  ADD CONSTRAINT fk_sep_item_checklist_completed_by
    FOREIGN KEY (completed_by)
    REFERENCES core_identity(core_identity_id);

ALTER TABLE separation_office_item_core_checklist
  ADD CONSTRAINT fk_sep_item_checklist_record_status
    FOREIGN KEY (record_status_id)
    REFERENCES record_status(record_status_id);


ALTER TABLE separation_supervisor
  ADD CONSTRAINT fk_sep_supervisor_initiation
    FOREIGN KEY (separation_initiation_id)
    REFERENCES separation_initiation(separation_initiation_id);

ALTER TABLE separation_supervisor
  ADD CONSTRAINT fk_sep_supervisor_supervisor
    FOREIGN KEY (supervisor_id)
    REFERENCES core_identity(core_identity_id);

ALTER TABLE separation_supervisor
  ADD CONSTRAINT fk_sep_supervisor_job
    FOREIGN KEY (job_id)
    REFERENCES job(job_id);

ALTER TABLE separation_supervisor
  ADD CONSTRAINT fk_sep_supervisor_record_status
    FOREIGN KEY (record_status_id)
    REFERENCES record_status(record_status_id);
